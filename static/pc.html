<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ‰¹ - AI ä½œä¸šæ‰¹æ”¹ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¸»å¸ƒå±€ï¼šå·¦å³åˆ†æ  */
        .main-layout {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§ï¼šè®¡åˆ’åˆ—è¡¨ */
        .plan-sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .plan-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background: #4CAF50;
            color: white;
        }

        .plan-sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .plan-sidebar-toolbar {
            display: flex;
            gap: 5px;
        }

        .plan-sidebar-toolbar button {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }

        .plan-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .plan-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            gap: 8px;
        }

        .plan-item:hover {
            background: #f0f0f0;
        }

        .plan-item.active {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .plan-item-content {
            flex: 1;
            min-width: 0;
        }

        .plan-item-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .plan-item-meta {
            font-size: 10px;
            color: #666;
            margin-bottom: 3px;
            display: flex;
            gap: 8px;
        }

        .plan-item-desc {
            font-size: 10px;
            color: #999;
            line-height: 1.4;
            max-height: 28px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* è®¡åˆ’æ“ä½œé“¾æ¥ï¼ˆä»…åœ¨é€‰ä¸­æ—¶æ˜¾ç¤ºï¼‰ */
        .plan-actions {
            display: none;
            flex-direction: column;
            gap: 2px;
            justify-content: flex-start;
            padding-top: 2px;
        }

        .plan-item.active .plan-actions {
            display: flex;
        }

        .plan-actions a {
            font-size: 10px;
            color: #4CAF50;
            text-decoration: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .plan-actions a:hover {
            background: #4CAF50;
            color: white;
        }

        /* äºŒç»´ç æ‚¬æµ®æ˜¾ç¤º */
        .qrcode-hover-container {
            position: relative;
        }

        .qrcode-popup {
            display: none;
            position: fixed;
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 200px;
            pointer-events: none;
        }

        .qrcode-popup img {
            width: 100%;
            display: block;
            border-radius: 4px;
        }

        .qrcode-popup-title {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 6px;
            line-height: 1.3;
        }

        /* è®¡åˆ’åˆ—è¡¨å®¹å™¨ */
        .plan-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* å³ä¾§ï¼šæ‰¹æ”¹ä»»åŠ¡åŒºåŸŸ */
        .records-area {
            flex: 1;
            display: none;
            flex-direction: column;
            background: white;
        }

        .records-area.active {
            display: flex;
        }

        .records-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .records-header h2 {
            font-size: 20px;
            color: #333;
        }

        .records-list {
            flex: 1;
            overflow-y: auto;
        }

        .record-item {
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .record-item:hover {
            background: #f9f9f9;
        }

        .record-item.active {
            background: #e3f2fd;
        }

        .record-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-title {
            font-weight: bold;
            color: #333;
        }

        .record-meta {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .record-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cfe2ff; color: #084298; }
        .status-done { background: #d1e7dd; color: #0f5132; }
        .status-failed { background: #f8d7da; color: #842029; }

        /* æ‰¹é‡æ“ä½œå·¥å…·æ  */
        .batch-actions-toolbar {
            padding: 10px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .batch-actions-toolbar input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .record-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            margin: 0;
        }

        /* è®°å½•è¯¦æƒ…ï¼ˆå±•å¼€å†…å®¹ï¼‰ */
        .record-detail {
            display: none;
            padding: 15px;
            background: #f9f9f9;
            border-top: 1px solid #ddd;
        }

        .record-detail.active {
            display: block;
        }

        /* è¯¦æƒ…ç½‘æ ¼ï¼šæ‰¹æ”¹ç»“æœ + å›¾ç‰‡&è¯†åˆ«å†…å®¹ */
        .detail-grid {
            display: grid;
            grid-template-columns: 3fr 1.5fr;
            gap: 15px;
        }

        .detail-column {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }

        .detail-column-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ddd;
            flex-shrink: 0;
        }

        .detail-column-result .detail-column-title {
            border-bottom-color: #4CAF50;
            font-size: 16px;
        }

        .detail-column-ocr .detail-column-title {
            border-bottom-color: #2196F3;
        }

        .detail-column-images .detail-column-title {
            border-bottom-color: #FF9800;
        }

        .detail-column-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* å›¾ç‰‡ç¼©ç•¥å›¾å®¹å™¨ */
        .images-thumbnails {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .images-thumbnails img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.2s;
        }

        .images-thumbnails img:hover {
            border-color: #FF9800;
            transform: scale(1.05);
        }

        /* è¯†åˆ«å†…å®¹åŒºåŸŸ */
        .ocr-content {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .ocr-content-title {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }

        .ocr-content pre {
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.5;
            margin: 0;
            color: #333;
        }

        .detail-actions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        button.small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }

        .modal-footer button {
            margin-left: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 300px;
            font-family: monospace;
            resize: vertical;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Markdown æ ·å¼ */
        .result-content h1, .result-content h2, .result-content h3, .result-content h4 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .result-content h1 { font-size: 20px; border-bottom: 2px solid #4CAF50; padding-bottom: 6px; }
        .result-content h2 { font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
        .result-content h3 { font-size: 16px; }
        .result-content h4 { font-size: 14px; }

        .result-content p {
            margin: 8px 0;
            line-height: 1.7;
        }

        .result-content ul, .result-content ol {
            margin: 8px 0;
            padding-left: 25px;
            line-height: 1.7;
        }

        .result-content li {
            margin: 4px 0;
        }

        .result-content code {
            background: #f5f5f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #e91e63;
        }

        .result-content pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .result-content pre code {
            background: transparent;
            padding: 0;
            color: #333;
        }

        .result-content blockquote {
            border-left: 4px solid #4CAF50;
            padding-left: 12px;
            margin: 8px 0;
            color: #666;
        }

        .result-content strong {
            font-weight: bold;
        }

        .result-content a {
            color: #2196F3;
            text-decoration: none;
        }

        .result-content a:hover {
            text-decoration: underline;
        }

        /* ç©ºçŠ¶æ€å ä½ */
        .empty-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        /* å›¾ç‰‡æµè§ˆå™¨æ¨¡æ€æ¡† */
        .image-viewer-modal {
            background: rgba(0, 0, 0, 0.95);
        }

        .image-viewer-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-container img {
            max-width: 90%;
            max-height: 90vh;
            object-fit: contain;
            user-select: none;
        }

        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 50px;
            height: 50px;
            line-height: 50px;
            text-align: center;
            z-index: 1001;
        }

        .image-viewer-close:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .image-viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 60px;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
            padding: 20px;
            width: 80px;
            height: 80px;
            line-height: 40px;
            text-align: center;
            transition: background 0.3s;
            z-index: 1001;
        }

        .image-viewer-nav:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .image-viewer-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .image-viewer-prev {
            left: 20px;
        }

        .image-viewer-next {
            right: 20px;
        }

        .image-viewer-counter {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1001;
        }

        .image-viewer-rotate-btn,
        .image-viewer-confirm-btn {
            background: rgba(255, 152, 0, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-viewer-rotate-btn:hover,
        .image-viewer-confirm-btn:hover {
            background: rgba(255, 152, 0, 1);
            transform: scale(1.05);
        }

        .image-viewer-confirm-btn {
            background: rgba(76, 175, 80, 0.9);
        }

        .image-viewer-confirm-btn:hover {
            background: rgba(76, 175, 80, 1);
        }

        /* Loading Spinner æ ·å¼ */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        <!-- å·¦ä¾§ï¼šè®¡åˆ’åˆ—è¡¨ -->
        <div class="plan-sidebar">
            <div class="plan-sidebar-header">
                <h1>æ™ºæ‰¹</h1>
                <div class="plan-sidebar-toolbar">
                    <button style="width: 100%; background: #4CAF50; color: white; font-weight: bold;" onclick="showCreatePlanModal()">â• æ–°å»ºè®¡åˆ’</button>
                </div>
            </div>
            <div class="plan-list-container" id="planList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ‰¹æ”¹ä»»åŠ¡åˆ—è¡¨ + è¯¦æƒ… -->
        <div class="records-area" id="recordsArea">
            <div class="records-header">
                <h2 id="currentPlanTitle">æ‰¹æ”¹è®¡åˆ’</h2>
            </div>
            <div class="records-list" id="recordsList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç©ºçŠ¶æ€å ä½ -->
        <div id="emptyPlaceholder" class="empty-placeholder">
            <div>
                <p style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</p>
                <p style="font-size: 18px;">è¯·é€‰æ‹©ä¸€ä¸ªæ‰¹æ”¹è®¡åˆ’</p>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘è®¡åˆ’æ¨¡æ€æ¡† -->
    <div id="createPlanModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" id="planModalTitle">åˆ›å»ºæ‰¹æ”¹è®¡åˆ’</div>
            <input type="hidden" id="planModalMode" value="create">
            <input type="hidden" id="planModalOriginalName" value="">

            <!-- ä¸Šéƒ¨ï¼šåŸºæœ¬ä¿¡æ¯ -->
            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                    <label><span style="color: red;">*</span> è®¡åˆ’åç§°</label>
                    <input type="text" id="newPlanName" placeholder="ä¾‹å¦‚ï¼šè¯­æ–‡ä½œä¸šç¬¬ä¸€å•å…ƒ">
                </div>
                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                    <label>æè¿°</label>
                    <input type="text" id="newPlanDescription" placeholder="ç®€çŸ­æè¿°ï¼ˆå¯é€‰ï¼‰">
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label>æ‰¹æ”¹æ¨¡å¼</label>
                    <select id="newPlanCorrectionMode" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="ocr">OCR + AI</option>
                        <option value="qwen-vl">Qwen-VL å¤šæ¨¡æ€</option>
                    </select>
                </div>
            </div>

            <!-- ä¸‹éƒ¨ï¼šæ‰¹æ”¹è¦æ±‚å’Œæ ‡å‡†ç­”æ¡ˆ -->
            <div style="display: flex; gap: 20px; flex: 1; min-height: 0;">
                <!-- æ‰¹æ”¹è¦æ±‚ -->
                <div class="form-group" style="flex: 1; margin-bottom: 0; display: flex; flex-direction: column; min-height: 0;">
                    <label><span style="color: red;">*</span> æ‰¹æ”¹è¦æ±‚</label>
                    <textarea id="newPlanPrompt" style="flex: 1; min-height: 0; font-size: 13px; resize: none;" placeholder="è¯·è¾“å…¥æ‰¹æ”¹è¦æ±‚..."></textarea>
                </div>

                <!-- æ ‡å‡†ç­”æ¡ˆ -->
                <div class="form-group" style="flex: 1; margin-bottom: 0; display: flex; flex-direction: column; min-height: 0;">
                    <label>å‚è€ƒç­”æ¡ˆ/è¯„åˆ†æ ‡å‡†</label>
                    <textarea id="newPlanStandardAnswer" style="flex: 1; min-height: 0; font-size: 13px; resize: none;" placeholder="æ­¤å†…å®¹å°†è‡ªåŠ¨é™„åŠ åˆ°æ‰¹æ”¹è¦æ±‚ä¸­ï¼Œå¸®åŠ© AI æ›´å‡†ç¡®åœ°æ‰¹æ”¹ä½œä¸šï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
            </div>

            <div class="modal-footer" style="margin-top: 15px;">
                <button class="secondary" onclick="closeModal('createPlanModal')">å–æ¶ˆ</button>
                <button id="planModalSubmitBtn" onclick="savePlan()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹ä¸Šä¸€æ¬¡æ‰¹æ”¹ç»“æœæ¨¡æ€æ¡† -->
    <div id="previousResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“œ ä¸Šä¸€æ¬¡æ‰¹æ”¹ç»“æœ</div>
            <div id="previousResultContent" class="result-content"></div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('previousResultModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æµè§ˆå™¨æ¨¡æ€æ¡† -->
    <div id="imageViewerModal" class="modal image-viewer-modal">
        <div class="image-viewer-container">
            <button class="image-viewer-close" onclick="closeImageViewer()">âœ•</button>
            <button class="image-viewer-nav image-viewer-prev" onclick="prevImage()">â€¹</button>
            <button class="image-viewer-nav image-viewer-next" onclick="nextImage()">â€º</button>
            <div id="imageViewerWrapper" style="position: relative; display: inline-block;">
                <img id="imageViewerImg" src="" alt="ä½œä¸šå›¾ç‰‡">
                <canvas id="imageViewerCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
            </div>
            <div style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1001;">
                <button class="image-viewer-rotate-btn" onclick="rotateCurrentImage()">ğŸ”„ æ—‹è½¬ 90Â°</button>
                <button class="image-viewer-confirm-btn" onclick="confirmRotation()" style="display: none;">âœ“ ç¡®å®šæ—‹è½¬</button>
            </div>
            <div class="image-viewer-counter">
                <span id="imageViewerCounter">1 / 1</span>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰æç¤ºæ¡† -->
    <div id="customAlertModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" id="customAlertTitle">æç¤º</div>
            <div id="customAlertMessage" style="padding: 20px 0; line-height: 1.6; color: #333;"></div>
            <div class="modal-footer" style="text-align: center;">
                <button onclick="closeCustomAlert()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤æ¡† -->
    <div id="customConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" id="customConfirmTitle">ç¡®è®¤</div>
            <div id="customConfirmMessage" style="padding: 20px 0; line-height: 1.6; color: #333;"></div>
            <div class="modal-footer" style="text-align: center;">
                <button class="secondary" onclick="cancelCustomConfirm()">å–æ¶ˆ</button>
                <button onclick="confirmCustomConfirm()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentPlan = null;
        let autoRefreshInterval = null;
        let currentExpandedRecordId = null;
        let lastRecordsData = null; // ç¼“å­˜ä¸Šæ¬¡çš„è®°å½•æ•°æ®

        // å›¾ç‰‡æµè§ˆå™¨ç›¸å…³å˜é‡
        let currentImages = []; // å½“å‰è®°å½•çš„æ‰€æœ‰å›¾ç‰‡
        let currentImageIndex = 0; // å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ç´¢å¼•
        let currentAnnotations = []; // å½“å‰è®°å½•çš„æ ‡æ³¨æ•°æ®
        let currentImageRotations = []; // å½“å‰è®°å½•çš„æ—‹è½¬è§’åº¦
        let currentRecordId = ''; // å½“å‰è®°å½•ID
        let currentPlanName = ''; // å½“å‰æ‰¹æ”¹è®¡åˆ’åç§°
        let pendingRotation = 0; // å¾…æäº¤çš„æ—‹è½¬è§’åº¦ï¼ˆ0, 90, 180, 270ï¼‰

        // åˆå§‹åŒ–
        window.onload = function() {
            // é…ç½® marked.js æ”¯æŒæ¢è¡Œ
            marked.setOptions({
                breaks: true,  // æ”¯æŒå•æ¢è¡Œç¬¦æ¢è¡Œï¼ˆGFM é£æ ¼ï¼‰
                gfm: true      // å¯ç”¨ GitHub Flavored Markdown
            });

            loadPlans();
            // æ¢å¤ä¸Šæ¬¡çš„é€‰æ‹©çŠ¶æ€
            restoreState();
            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', handleKeyPress);
        };

        // ä¿å­˜çŠ¶æ€åˆ° localStorage
        function saveState() {
            const state = {
                planName: currentPlan ? currentPlan.plan_name : null,
                expandedRecordId: currentExpandedRecordId
            };
            localStorage.setItem('homeworkGradingState', JSON.stringify(state));
        }

        // æ¢å¤çŠ¶æ€
        function restoreState() {
            try {
                const stateJson = localStorage.getItem('homeworkGradingState');
                if (stateJson) {
                    const state = JSON.parse(stateJson);
                    if (state.planName) {
                        // å»¶è¿Ÿä¸€ä¸‹ï¼Œç­‰å¾…è®¡åˆ’åˆ—è¡¨åŠ è½½å®Œæˆ
                        setTimeout(() => {
                            selectPlan(state.planName);
                            if (state.expandedRecordId) {
                                currentExpandedRecordId = state.expandedRecordId;
                            }
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('æ¢å¤çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½è®¡åˆ’åˆ—è¡¨
        async function loadPlans() {
            try {
                const response = await fetch(`${API_BASE}/plans`);
                const data = await response.json();
                displayPlans(data.plans);
            } catch (error) {
                console.error('åŠ è½½è®¡åˆ’å¤±è´¥:', error);
                document.getElementById('planList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ˜¾ç¤ºè®¡åˆ’åˆ—è¡¨
        function displayPlans(plans) {
            const container = document.getElementById('planList');
            if (plans.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— è®¡åˆ’<br>ç‚¹å‡»æ–°å»ºåˆ›å»º</div>';
                return;
            }

            container.innerHTML = plans.map(plan => {
                const isActive = currentPlan && currentPlan.plan_name === plan.plan_name;

                // æ ¼å¼åŒ–æ—¥æœŸ
                let dateStr = '';
                if (plan.created_at) {
                    try {
                        const date = new Date(plan.created_at);
                        dateStr = date.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        }).replace(/\//g, '-');
                    } catch (e) {
                        dateStr = '';
                    }
                }

                // æˆªå–æè¿°å­—æ®µï¼ˆå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºæš‚æ— æè¿°ï¼‰
                const desc = plan.description ? (plan.description.length > 30 ? plan.description.substring(0, 30) + '...' : plan.description) : 'æš‚æ— æè¿°';

                return `
                <div class="plan-item ${isActive ? 'active' : ''}" onclick="selectPlan('${plan.plan_name}')">
                    <!-- å·¦ä¾§å†…å®¹ -->
                    <div class="plan-item-content">
                        <div class="plan-item-name">${plan.plan_name}</div>
                        <div class="plan-item-meta">
                            <span>è®°å½•: ${plan.record_count} æ¡</span>
                            ${dateStr ? `<span>${dateStr}</span>` : ''}
                        </div>
                        <div class="plan-item-desc">${desc}</div>
                    </div>

                    <!-- å³ä¾§æ“ä½œé“¾æ¥ï¼ˆä»…é€‰ä¸­æ—¶æ˜¾ç¤ºï¼‰ -->
                    <div class="plan-actions">
                        <div class="qrcode-hover-container" onmouseenter="showQRCodePopup(event, '${plan.plan_name}')" onmouseleave="hideQRCodePopup()">
                            <a>æ‰«ç å½•å…¥</a>
                            <div class="qrcode-popup" id="qrcode-popup-${plan.plan_name}">
                                <img src="${API_BASE}/plans/${encodeURIComponent(plan.plan_name)}/qrcode" alt="äºŒç»´ç ">
                                <div class="qrcode-popup-title">æ‰«ç ä¸Šä¼ ä½œä¸š</div>
                            </div>
                        </div>
                        <a onclick="event.stopPropagation(); showEditPlanModal()">ç¼–è¾‘è®¡åˆ’</a>
                        <a onclick="event.stopPropagation(); batchRegrade()">é‡æ–°æ‰¹æ”¹</a>
                        <a onclick="event.stopPropagation(); deletePlan()" style="color: #f44336;">åˆ é™¤è®¡åˆ’</a>
                    </div>
                </div>
                `;
            }).join('');
        }

        // é€‰æ‹©è®¡åˆ’
        async function selectPlan(planName) {
            try {
                const response = await fetch(`${API_BASE}/plans/${encodeURIComponent(planName)}`);
                const data = await response.json();
                currentPlan = data.plan;

                // æ›´æ–°æ ‡é¢˜
                document.getElementById('currentPlanTitle').textContent = planName;

                // æ˜¾ç¤ºå³ä¾§åŒºåŸŸ
                document.getElementById('emptyPlaceholder').style.display = 'none';
                document.getElementById('recordsArea').classList.add('active');

                // åŠ è½½è®°å½•
                loadRecords();

                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆ1ç§’ï¼‰
                startAutoRefresh();

                // æ›´æ–°è®¡åˆ’åˆ—è¡¨é€‰ä¸­çŠ¶æ€
                loadPlans();

                // ä¿å­˜çŠ¶æ€
                saveState();
            } catch (error) {
                console.error('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥:', error);
                showAlert('åŠ è½½è®¡åˆ’å¤±è´¥', 'é”™è¯¯');
            }
        }

        // æ˜¾ç¤ºäºŒç»´ç æ¨¡æ€æ¡†
        function showQRCodeModal() {
            if (!currentPlan) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰¹æ”¹è®¡åˆ’', 'æç¤º');
                return;
            }

            const qrcodeUrl = `${API_BASE}/plans/${encodeURIComponent(currentPlan.plan_name)}/qrcode`;
            document.getElementById('qrcodeModalContent').innerHTML = `
                <img src="${qrcodeUrl}" alt="äºŒç»´ç " style="width: 100%; max-width: 300px; border: 2px solid #ddd; border-radius: 6px;">
            `;
            showModal('qrcodeModal');
        }

        // åŠ è½½è®°å½•åˆ—è¡¨
        async function loadRecords() {
            if (!currentPlan) return;

            try {
                const response = await fetch(`${API_BASE}/records/${encodeURIComponent(currentPlan.plan_name)}`);
                const data = await response.json();

                // æ™ºèƒ½æ›´æ–°ï¼šåªåœ¨æ•°æ®å˜åŒ–æ—¶æ›´æ–°
                if (hasRecordsChanged(data.records)) {
                    displayRecords(data.records);
                    lastRecordsData = JSON.stringify(data.records);
                } else if (currentExpandedRecordId) {
                    // å³ä½¿åˆ—è¡¨æ²¡å˜åŒ–ï¼Œä¹Ÿæ›´æ–°å±•å¼€è®°å½•çš„è¯¦æƒ…ï¼ˆå› ä¸ºçŠ¶æ€å¯èƒ½å˜åŒ–ï¼‰
                    silentUpdateExpandedRecord();
                }
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
                document.getElementById('recordsList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ£€æŸ¥è®°å½•æ˜¯å¦æœ‰å˜åŒ–
        function hasRecordsChanged(newRecords) {
            if (!lastRecordsData) return true;
            const newData = JSON.stringify(newRecords);
            return lastRecordsData !== newData;
        }

        // é™é»˜æ›´æ–°å±•å¼€è®°å½•ï¼ˆä¸é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼Œé¿å…æ»šåŠ¨ä½ç½®ä¸¢å¤±ï¼‰
        async function silentUpdateExpandedRecord() {
            if (!currentExpandedRecordId) return;

            const detailDiv = document.getElementById(`detail-${currentExpandedRecordId}`);
            if (!detailDiv || !detailDiv.classList.contains('active')) return;

            // ä¿å­˜æ»šåŠ¨ä½ç½®
            const scrollPositions = saveScrollPositions();

            try {
                const response = await fetch(`${API_BASE}/records/${encodeURIComponent(currentPlan.plan_name)}/${currentExpandedRecordId}`);
                const data = await response.json();
                const record = data.record;

                // æ›´æ–°è¯¦æƒ…å†…å®¹
                detailDiv.innerHTML = generateDetailHTML(record, currentExpandedRecordId);

                // æ¢å¤æ»šåŠ¨ä½ç½®
                restoreScrollPositions(scrollPositions);
            } catch (error) {
                console.error('é™é»˜æ›´æ–°è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // ä¿å­˜æ‰€æœ‰æ»šåŠ¨ä½ç½®
        function saveScrollPositions() {
            const positions = {};
            const containers = document.querySelectorAll('.detail-column-content');
            containers.forEach((container, index) => {
                positions[index] = container.scrollTop;
            });
            return positions;
        }

        // æ¢å¤æ»šåŠ¨ä½ç½®
        function restoreScrollPositions(positions) {
            setTimeout(() => {
                const containers = document.querySelectorAll('.detail-column-content');
                containers.forEach((container, index) => {
                    if (positions[index] !== undefined) {
                        container.scrollTop = positions[index];
                    }
                });
            }, 0);
        }

        // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
        function displayRecords(records) {
            const container = document.getElementById('recordsList');

            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ‰¹æ”¹è®°å½•</div>';
                currentExpandedRecordId = null;
                return;
            }

            // æ·»åŠ æ‰¹é‡æ“ä½œå·¥å…·æ 
            let html = `
            <div class="batch-actions-toolbar">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()" title="å…¨é€‰/å–æ¶ˆå…¨é€‰">
                    <span style="font-size: 13px; color: #666;">å…¨é€‰</span>
                </div>
                <div id="batchActions" style="display: none; gap: 8px; align-items: center;">
                    <span style="font-size: 12px; color: #666;">å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡</span>
                    <button class="small danger" onclick="batchDeleteRecords()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                </div>
            </div>
            `;

            html += records.map(record => `
                <div class="record-item ${currentExpandedRecordId === record.id ? 'active' : ''}" onclick="toggleRecord('${record.id}')">
                    <div class="record-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" class="record-checkbox" value="${record.id}" onclick="event.stopPropagation(); updateBatchActionButtons()">
                            <div>
                                <div class="record-title">å­¦ç”Ÿ: ${record.student}</div>
                                <div class="record-meta">
                                    ${new Date(record.created_at).toLocaleString('zh-CN')}
                                    ${record.regrade_count > 0 ? ` | é‡æ‰¹ ${record.regrade_count} æ¬¡` : ''}
                                </div>
                            </div>
                        </div>
                        <span class="record-status status-${record.status}">${getStatusText(record.status)}</span>
                    </div>
                    <div id="detail-${record.id}" class="record-detail"></div>
                </div>
            `).join('');

            container.innerHTML = html;

            // å¦‚æœæœ‰å±•å¼€çš„è®°å½•ï¼Œé‡æ–°åŠ è½½å…¶è¯¦æƒ…
            if (currentExpandedRecordId) {
                const detailDiv = document.getElementById(`detail-${currentExpandedRecordId}`);
                if (detailDiv) {
                    reloadRecordDetail(currentExpandedRecordId);
                }
            }

            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€
            updateBatchActionButtons();
        }

        // ç”Ÿæˆè¯¦æƒ… HTMLï¼ˆæå–ä¸ºå‡½æ•°ä»¥ä¾¿å¤ç”¨ï¼‰
        function generateDetailHTML(record, recordId) {
            let html = '<div class="detail-grid">';

            // ç¬¬ä¸€åˆ—ï¼šæ‰¹æ”¹ç»“æœï¼ˆæ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæ ‡é¢˜å’Œå†…å®¹ï¼‰
            html += '<div class="detail-column detail-column-result">';

            // æ ¹æ®çŠ¶æ€è®¾ç½®æ ‡é¢˜
            let titleHtml = '';
            if (record.status === 'done') {
                titleHtml = 'âœ… æ‰¹æ”¹ç»“æœ';
            } else if (record.status === 'failed') {
                titleHtml = 'âŒ æ‰¹æ”¹å¤±è´¥';
            } else if (record.status === 'processing') {
                titleHtml = 'â³ æ‰¹æ”¹ä¸­...';
            } else {
                titleHtml = 'â³ ç­‰å¾…æ‰¹æ”¹';
            }
            html += `<div class="detail-column-title">${titleHtml}</div>`;

            html += '<div class="detail-column-content">';

            // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºå†…å®¹
            if (record.status === 'done' && record.result) {
                html += `<div class="result-content">${marked.parse(record.result)}</div>`;
            } else if (record.status === 'failed') {
                html += `<div style="color: red; padding: 20px; text-align: center;">`;
                html += `<div style="font-size: 48px; margin-bottom: 10px;">âŒ</div>`;
                html += `<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">æ‰¹æ”¹å¤±è´¥</div>`;
                if (record.error) {
                    html += `<div style="color: #666; font-size: 14px;">${record.error}</div>`;
                }
                html += `</div>`;
            } else if (record.status === 'processing') {
                html += `<div style="padding: 40px; text-align: center;">`;
                html += `<div class="loading-spinner" style="margin: 0 auto 20px;"></div>`;
                html += `<div style="font-size: 16px; color: #666;">æ­£åœ¨æ‰¹æ”¹ä¸­ï¼Œè¯·ç¨å€™...</div>`;
                if (record.ocr_text && !record.ocr_text.includes('ä½¿ç”¨ Qwen-VL')) {
                    html += `<div style="margin-top: 15px; font-size: 14px; color: #999;">å·²å®Œæˆæ–‡å­—è¯†åˆ«ï¼Œæ­£åœ¨è°ƒç”¨ AI æ‰¹æ”¹</div>`;
                }
                html += `</div>`;
            } else {
                // pending çŠ¶æ€
                html += `<div style="padding: 40px; text-align: center;">`;
                html += `<div style="font-size: 48px; margin-bottom: 10px;">â³</div>`;
                html += `<div style="font-size: 16px; color: #666;">ç­‰å¾…æ‰¹æ”¹...</div>`;
                html += `</div>`;
            }

            html += '</div></div>';

            // ç¬¬äºŒåˆ—ï¼šå›¾ç‰‡ + è¯†åˆ«å†…å®¹
            html += '<div class="detail-column detail-column-images">';
            html += '<div class="detail-column-title">ğŸ“· å›¾ç‰‡ & è¯†åˆ«å†…å®¹</div>';
            html += '<div class="detail-column-content">';

            // å›¾ç‰‡ç¼©ç•¥å›¾
            if (record.images && record.images.length > 0) {
                html += '<div class="images-thumbnails">';
                // ç”Ÿæˆæ‰€æœ‰å›¾ç‰‡çš„ URL æ•°ç»„
                const imageUrls = record.images.map(img => `${API_BASE}/data/${currentPlan.plan_name}/${img}`);
                const imageUrlsJson = JSON.stringify(imageUrls).replace(/"/g, '&quot;');

                // ä¼ é€’ annotations æ•°æ®
                const annotationsJson = JSON.stringify(record.annotations || []).replace(/"/g, '&quot;');

                // ä¼ é€’ image_rotations æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const imageRotationsJson = JSON.stringify(record.image_rotations || []).replace(/"/g, '&quot;');

                record.images.forEach((img, index) => {
                    const imgUrl = `${API_BASE}/data/${currentPlan.plan_name}/${img}`;
                    html += `<img id="thumbnail-${record.id}-${index}" src="${imgUrl}" onclick="event.stopPropagation(); openImageViewer(JSON.parse('${imageUrlsJson}'), ${index}, JSON.parse('${annotationsJson}'), JSON.parse('${imageRotationsJson}'), '${record.id}', '${currentPlan.plan_name}')" alt="ä½œä¸šå›¾ç‰‡" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾ï¼ˆå«æ ‡æ³¨ï¼‰">`;
                });
                html += '</div>';
            } else {
                html += '<div style="color: #999; margin-bottom: 15px;">æ— å›¾ç‰‡</div>';
            }

            // å¦‚æœæœ‰æ ‡æ³¨æ•°æ®ï¼Œæ˜¾ç¤ºæ ‡æ³¨åˆ—è¡¨
            if (record.annotations && record.annotations.length > 0) {
                html += '<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">';
                html += '<div style="font-size: 12px; font-weight: bold; color: #856404; margin-bottom: 8px;">ğŸ“ æ‰¹æ”¹æ ‡æ³¨</div>';
                record.annotations.forEach((ann, idx) => {
                    let statusColor = ann.status === 'correct' ? '#28a745' : (ann.status === 'partial' ? '#ff9800' : '#dc3545');
                    let statusIcon = ann.status === 'correct' ? 'âœ“' : (ann.status === 'partial' ? 'â–³' : 'âœ—');
                    html += `<div style="font-size: 11px; color: #666; margin-bottom: 5px;">`;
                    html += `<span style="color: ${statusColor}; font-weight: bold;">${statusIcon} é¢˜${ann.question_number}</span> `;
                    html += `<span style="color: #999;">${ann.score}</span> - ${ann.comment}`;
                    html += `</div>`;
                });
                html += '</div>';
            }

            // è¯†åˆ«å†…å®¹
            html += '<div class="ocr-content">';
            html += '<div class="ocr-content-title">AI è¯†åˆ«çš„å†…å®¹</div>';

            // ä¼˜å…ˆæ˜¾ç¤ºç»“æ„åŒ–çš„è¯†åˆ«å†…å®¹
            if (record.recognized_content && record.recognized_content.questions && record.recognized_content.questions.length > 0) {
                record.recognized_content.questions.forEach((q, idx) => {
                    html += `<div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px; border-left: 3px solid #2196F3;">`;
                    html += `<div style="font-weight: bold; color: #2196F3; margin-bottom: 5px;">é¢˜ç›® ${q.number}</div>`;
                    html += `<div style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>é¢˜ç›®ï¼š</strong>${q.question_text}</div>`;
                    html += `<div style="font-size: 12px; color: #333;"><strong>å­¦ç”Ÿç­”æ¡ˆï¼š</strong>${q.student_answer}</div>`;
                    html += `</div>`;
                });
            } else if (record.ocr_text) {
                // å›é€€åˆ° OCR æ–‡æœ¬
                html += `<pre>${record.ocr_text}</pre>`;
            } else {
                html += '<div style="color: #999; font-size: 12px;">æš‚æ— è¯†åˆ«ç»“æœ</div>';
            }
            html += '</div>';

            html += '</div></div>';

            html += '</div>'; // end detail-grid

            // æ“ä½œæŒ‰é’®
            html += '<div class="detail-actions">';
            if (record.previous_result) {
                html += `<button class="small secondary" onclick="event.stopPropagation(); showPreviousResult('${recordId}')">ğŸ“œ æŸ¥çœ‹ä¸Šæ¬¡æ‰¹æ”¹</button>`;
            }
            html += `<button class="small danger" onclick="event.stopPropagation(); deleteRecord('${recordId}')">ğŸ—‘ï¸ åˆ é™¤</button>`;
            html += '</div>';

            return html;
        }

        // é‡æ–°åŠ è½½è®°å½•è¯¦æƒ…ï¼ˆç”¨äºè‡ªåŠ¨åˆ·æ–°æ—¶ä¿æŒå±•å¼€çŠ¶æ€ï¼‰
        async function reloadRecordDetail(recordId) {
            const detailDiv = document.getElementById(`detail-${recordId}`);
            if (!detailDiv) return;

            // ä¿å­˜æ»šåŠ¨ä½ç½®
            const scrollPositions = saveScrollPositions();

            try {
                const response = await fetch(`${API_BASE}/records/${encodeURIComponent(currentPlan.plan_name)}/${recordId}`);
                const data = await response.json();
                const record = data.record;

                detailDiv.innerHTML = generateDetailHTML(record, recordId);
                detailDiv.classList.add('active');

                // æ¢å¤æ»šåŠ¨ä½ç½®
                restoreScrollPositions(scrollPositions);
            } catch (error) {
                console.error('é‡æ–°åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢è®°å½•è¯¦æƒ…
        async function toggleRecord(recordId) {
            const detailDiv = document.getElementById(`detail-${recordId}`);

            // å¦‚æœå·²å±•å¼€ï¼Œåˆ™æ”¶èµ·
            if (currentExpandedRecordId === recordId) {
                detailDiv.classList.remove('active');
                currentExpandedRecordId = null;
                // æ›´æ–°æ ·å¼
                updateRecordItemActiveState();
                // ä¿å­˜çŠ¶æ€
                saveState();
                return;
            }

            // æ”¶èµ·ä¹‹å‰å±•å¼€çš„è®°å½•
            if (currentExpandedRecordId) {
                const prevDetailDiv = document.getElementById(`detail-${currentExpandedRecordId}`);
                if (prevDetailDiv) {
                    prevDetailDiv.classList.remove('active');
                }
            }

            // å±•å¼€æ–°çš„è®°å½•
            currentExpandedRecordId = recordId;

            try {
                const response = await fetch(`${API_BASE}/records/${encodeURIComponent(currentPlan.plan_name)}/${recordId}`);
                const data = await response.json();
                const record = data.record;

                detailDiv.innerHTML = generateDetailHTML(record, recordId);
                detailDiv.classList.add('active');

                // æ›´æ–°è®°å½•é¡¹çš„ active æ ·å¼
                updateRecordItemActiveState();

                // ä¿å­˜çŠ¶æ€
                saveState();
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                detailDiv.innerHTML = '<div style="color: red; padding: 10px;">åŠ è½½å¤±è´¥</div>';
                detailDiv.classList.add('active');
            }
        }

        // æ›´æ–°è®°å½•é¡¹çš„ active çŠ¶æ€
        function updateRecordItemActiveState() {
            document.querySelectorAll('.record-item').forEach(item => {
                const recordId = item.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                if (recordId === currentExpandedRecordId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // æ˜¾ç¤ºä¸Šä¸€æ¬¡æ‰¹æ”¹ç»“æœ
        async function showPreviousResult(recordId) {
            try {
                const response = await fetch(`${API_BASE}/records/${encodeURIComponent(currentPlan.plan_name)}/${recordId}`);
                const data = await response.json();
                const record = data.record;

                if (record.previous_result) {
                    document.getElementById('previousResultContent').innerHTML = marked.parse(record.previous_result);
                    showModal('previousResultModal');
                }
            } catch (error) {
                console.error('åŠ è½½å†å²ç»“æœå¤±è´¥:', error);
            }
        }

        // åˆ é™¤è®°å½•
        async function deleteRecord(recordId) {
            showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼', async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(`${API_BASE}/records/${encodeURIComponent(currentPlan.plan_name)}/${recordId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showAlert('åˆ é™¤æˆåŠŸ');
                        currentExpandedRecordId = null;
                        loadRecords();
                    } else {
                        const error = await response.json();
                        showAlert('åˆ é™¤å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
                    showAlert('åˆ é™¤å¤±è´¥', 'é”™è¯¯');
                }
            });
        }

        // æ‰¹é‡åˆ é™¤è®°å½•
        async function batchDeleteRecords() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            if (checkboxes.length === 0) {
                showAlert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            showConfirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} æ¡è®°å½•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼`, async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(`${API_BASE}/records/${encodeURIComponent(currentPlan.plan_name)}/batch-delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ record_ids: selectedIds })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showAlert(`æˆåŠŸåˆ é™¤ ${result.deleted_count} æ¡è®°å½•`);
                        currentExpandedRecordId = null;
                        loadRecords();
                    } else {
                        const error = await response.json();
                        showAlert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                    showAlert('æ‰¹é‡åˆ é™¤å¤±è´¥', 'é”™è¯¯');
                }
            });
        }

        // åˆ é™¤æ‰¹æ”¹è®¡åˆ’
        async function deletePlan() {
            if (!currentPlan) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰¹æ”¹è®¡åˆ’');
                return;
            }

            showConfirm(`ç¡®å®šè¦åˆ é™¤è®¡åˆ’"${currentPlan.plan_name}"å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤è®¡åˆ’ä¸‹çš„æ‰€æœ‰è®°å½•å’Œå›¾ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ï¼`, async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(`${API_BASE}/plans/${encodeURIComponent(currentPlan.plan_name)}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showAlert(`è®¡åˆ’å·²åˆ é™¤ï¼ˆ${result.deleted.records_count} æ¡è®°å½•ï¼Œ${result.deleted.images_count} å¼ å›¾ç‰‡ï¼‰`);

                        // æ¸…ç©ºå½“å‰é€‰æ‹©
                        currentPlan = null;
                        currentExpandedRecordId = null;

                        // éšè—å³ä¾§åŒºåŸŸ
                        document.getElementById('recordsArea').classList.remove('active');
                        document.getElementById('emptyPlaceholder').style.display = 'flex';

                        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                        stopAutoRefresh();

                        // é‡æ–°åŠ è½½è®¡åˆ’åˆ—è¡¨
                        loadPlans();

                        // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                        localStorage.removeItem('currentPlanName');
                    } else {
                        const error = await response.json();
                        showAlert('åˆ é™¤è®¡åˆ’å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('åˆ é™¤è®¡åˆ’å¤±è´¥:', error);
                    showAlert('åˆ é™¤è®¡åˆ’å¤±è´¥', 'é”™è¯¯');
                }
            });
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰è®°å½•
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateBatchActionButtons();
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€
        function updateBatchActionButtons() {
            const checkedCount = document.querySelectorAll('.record-checkbox:checked').length;
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');

            if (batchActions) {
                batchActions.style.display = checkedCount > 0 ? 'flex' : 'none';
            }
            if (selectedCount) {
                selectedCount.textContent = checkedCount;
            }

            // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const allCheckboxes = document.querySelectorAll('.record-checkbox');
            if (selectAllCheckbox && allCheckboxes.length > 0) {
                selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºè®¡åˆ’æ¨¡æ€æ¡†
        function showCreatePlanModal() {
            document.getElementById('planModalMode').value = 'create';
            document.getElementById('planModalOriginalName').value = '';
            document.getElementById('planModalTitle').textContent = 'åˆ›å»ºæ‰¹æ”¹è®¡åˆ’';
            document.getElementById('planModalSubmitBtn').textContent = 'åˆ›å»º';
            document.getElementById('newPlanName').value = '';
            document.getElementById('newPlanDescription').value = '';
            document.getElementById('newPlanStandardAnswer').value = '';
            document.getElementById('newPlanCorrectionMode').value = 'ocr';  // é»˜è®¤ä½¿ç”¨ OCR æ¨¡å¼

            // è®¾ç½®é»˜è®¤ Prompt
            const defaultPrompt = `è§’è‰²è®¾å®šï¼š
ä½ æ˜¯ä¸€åä¸“ä¸šã€ä¸¥è°¨ã€è€å¿ƒçš„ã€Œé“æ³•ï¼ˆé“å¾·ä¸æ³•æ²»ï¼‰ä½œä¸šæ‰¹æ”¹è€å¸ˆã€ï¼Œç†Ÿæ‚‰ä¹‰åŠ¡æ•™è‚²é˜¶æ®µé“å¾·ä¸æ³•æ²»è¯¾ç¨‹æ ‡å‡†ä¸ç­”é¢˜è¦æ±‚ã€‚

ä»»åŠ¡è¯´æ˜ï¼š
æˆ‘å°†æä¾›å›¾ç‰‡ç»™ä½ ï¼ŒåŒ…å«å°åˆ·ä½“é¢˜ç›®å’Œæ‰‹å†™ä½“ç­”æ¡ˆã€‚è¯·ä½ æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š


æ‰¹æ”¹è¦æ±‚ï¼Œæ‰€æœ‰è¦æ±‚ä¸€å®šè¦éµå®ˆï¼š
1. æŒ‰ç…§é¢˜ç›®å’Œæ­¥éª¤ä¸€è¡Œä¸€è¡Œè¾“å‡ºå†…å®¹
2. é¢˜ç›®å’Œæ­¥éª¤éƒ½éœ€è¦è¾“å‡º {å¾—åˆ†}/{æ€»åˆ†}
3.æ²¡æœ‰å¾—æ»¡åˆ†çš„ï¼Œéœ€è¦å†™å‡ºæ‰£åˆ†åŸå› 
4.æ²¡æœ‰ç»™å‡ºæ ‡å‡†ç­”æ¡ˆçš„é¢˜ç›®ä¸è¦æ‰¹æ”¹
5.\${xxx}è¿™ä¸ªæ ¼å¼æ˜¯æˆ‘å‘Šè¯‰ä½ è¾“å‡ºå†…å®¹çš„å ä½ç¬¦ï¼Œä½ è¾“å‡ºçš„æ—¶å€™ï¼Œéœ€è¦å¿½ç•¥ \${}ï¼ŒæŒ‰ç…§é‡Œé¢çš„å†…å®¹ç»™å°±å¥½
6.å¯¹äºæ­¥éª¤å ä½ç¬¦é‡Œé¢çš„å†…å®¹ï¼Œä½ éœ€è¦ä»æ ‡å‡†ç­”æ¡ˆä¸­æå–ï¼Œæå–å…³é”®å†…å®¹å³å¯ï¼Œå°½é‡ 3~5 ä¸ªå­—ï¼Œä¸ç”¨æŠŠå®Œæ•´æ­¥éª¤å†…å®¹å†™è¿›å»,æ­¤æ¡å¿…é¡»éµå®ˆ
7.å¦‚æœé¢˜ç›®åˆ†äº†å°é¢˜ç›®ï¼Œåˆ™æŒ‰ç…§å±‚çº§å…³ç³»è¾“å‡ºï¼Œé¢˜ç›®ã€å­é¢˜ç›®ã€æ­¥éª¤ç­‰ç­‰è¿™ç§å±‚çº§å…³ç³»
8.ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¾“å‡ºå½¢å¼è¾“å‡º markdown å†…å®¹ï¼Œä¸è¦å‡ºç°ä»»ä½•å…¶ä»–å†…å®¹
è¾“å‡ºæ ¼å¼
#\${é¢˜ç›®n}ï¼š\${æ€»å¾—åˆ†}/\${é¢˜ç›®æ€»åˆ†}
## \${å­é¢˜ç›®n}ï¼š\${å°ç‚¹å¾—åˆ†}/\${å°ç‚¹æ€»åˆ†}
** \${æ­¥éª¤1}**ï¼š\${æ­¥éª¤å¾—åˆ†}/\${æ­¥éª¤æ€»åˆ†}\${æ‰£åˆ†åŸå› æˆ–è€…ç»™åˆ†åŸå› }
** \${æ­¥éª¤2}**ï¼š\${æ­¥éª¤å¾—åˆ†}/\${æ­¥éª¤æ€»åˆ†} \${æ‰£åˆ†åŸå› æˆ–è€…ç»™åˆ†åŸå› }
...`;

            document.getElementById('newPlanPrompt').value = defaultPrompt;
            showModal('createPlanModal');
        }

        // æ˜¾ç¤ºç¼–è¾‘è®¡åˆ’æ¨¡æ€æ¡†
        function showEditPlanModal() {
            if (!currentPlan) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰¹æ”¹è®¡åˆ’', 'æç¤º');
                return;
            }

            document.getElementById('planModalMode').value = 'edit';
            document.getElementById('planModalOriginalName').value = currentPlan.plan_name;
            document.getElementById('planModalTitle').textContent = 'ç¼–è¾‘æ‰¹æ”¹è®¡åˆ’';
            document.getElementById('planModalSubmitBtn').textContent = 'ä¿å­˜';
            document.getElementById('newPlanName').value = currentPlan.plan_name;
            document.getElementById('newPlanDescription').value = currentPlan.description;
            document.getElementById('newPlanPrompt').value = currentPlan.prompt;
            document.getElementById('newPlanStandardAnswer').value = currentPlan.standard_answer || '';
            document.getElementById('newPlanCorrectionMode').value = currentPlan.correction_mode || 'ocr';  // åŠ è½½æ‰¹æ”¹æ¨¡å¼

            showModal('createPlanModal');
        }

        // ä¿å­˜è®¡åˆ’ï¼ˆåˆ›å»ºæˆ–ç¼–è¾‘ï¼‰
        async function savePlan() {
            const mode = document.getElementById('planModalMode').value;
            const name = document.getElementById('newPlanName').value.trim();
            const description = document.getElementById('newPlanDescription').value.trim();
            const prompt = document.getElementById('newPlanPrompt').value.trim();
            const standardAnswer = document.getElementById('newPlanStandardAnswer').value.trim();
            const correctionMode = document.getElementById('newPlanCorrectionMode').value;

            // åªéªŒè¯å¿…å¡«é¡¹
            if (!name || !prompt) {
                showAlert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼ˆæ ‡æœ‰çº¢è‰²*å·çš„å­—æ®µï¼‰', 'æç¤º');
                return;
            }

            if (mode === 'create') {
                // åˆ›å»ºæ¨¡å¼
                try {
                    const response = await fetch(`${API_BASE}/plans`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            plan_name: name,
                            description: description,
                            prompt: prompt,
                            standard_answer: standardAnswer,
                            correction_mode: correctionMode
                        })
                    });

                    if (response.ok) {
                        showAlert('åˆ›å»ºæˆåŠŸï¼', 'æˆåŠŸ');
                        closeModal('createPlanModal');
                        await loadPlans();

                        // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„è®¡åˆ’
                        selectPlan(name);
                    } else {
                        const error = await response.json();
                        showAlert('åˆ›å»ºå¤±è´¥: ' + error.detail, 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('åˆ›å»ºè®¡åˆ’å¤±è´¥:', error);
                    showAlert('åˆ›å»ºå¤±è´¥', 'é”™è¯¯');
                }
            } else {
                // ç¼–è¾‘æ¨¡å¼
                const originalName = document.getElementById('planModalOriginalName').value;

                try {
                    const response = await fetch(`${API_BASE}/plans/${encodeURIComponent(originalName)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            plan_name: name !== originalName ? name : undefined,
                            description: description,
                            prompt: prompt,
                            standard_answer: standardAnswer,
                            correction_mode: correctionMode
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showAlert('æ›´æ–°æˆåŠŸï¼', 'æˆåŠŸ');
                        closeModal('createPlanModal');
                        await loadPlans();

                        // å¦‚æœé‡å‘½åäº†ï¼Œé€‰æ‹©æ–°åç§°ï¼›å¦åˆ™åˆ·æ–°å½“å‰è®¡åˆ’
                        if (result.renamed) {
                            selectPlan(result.new_name);
                        } else {
                            selectPlan(name);
                        }
                    } else {
                        const error = await response.json();
                        showAlert('æ›´æ–°å¤±è´¥: ' + error.detail, 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('æ›´æ–°è®¡åˆ’å¤±è´¥:', error);
                    showAlert('æ›´æ–°å¤±è´¥', 'é”™è¯¯');
                }
            }
        }

        // æ‰¹é‡é‡æ–°æ‰¹æ”¹
        async function batchRegrade() {
            if (!currentPlan) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰¹æ”¹è®¡åˆ’', 'æç¤º');
                return;
            }

            showConfirm('ç¡®å®šè¦é‡æ–°æ‰¹æ”¹æ‰€æœ‰è®°å½•å—ï¼Ÿ', async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(`${API_BASE}/plans/${encodeURIComponent(currentPlan.plan_name)}/regrade`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });

                    if (response.ok) {
                        const data = await response.json();
                        showAlert(data.message, 'æˆåŠŸ');
                        loadRecords();
                    } else {
                        showAlert('æ‰¹é‡é‡æ–°æ‰¹æ”¹å¤±è´¥', 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('æ‰¹é‡é‡æ–°æ‰¹æ”¹å¤±è´¥:', error);
                    showAlert('æ“ä½œå¤±è´¥', 'é”™è¯¯');
                }
            });
        }

        // è‡ªåŠ¨åˆ·æ–°ï¼ˆ1ç§’ï¼‰
        function startAutoRefresh() {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(() => {
                if (currentPlan) {
                    loadRecords();
                }
            }, 1000); // 1ç§’åˆ·æ–°ä¸€æ¬¡
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function refreshRecords() {
            loadRecords();
        }

        // å·¥å…·å‡½æ•°
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…æ‰¹æ”¹',
                'processing': 'æ‰¹æ”¹ä¸­',
                'done': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // ==================== äºŒç»´ç å¼¹å‡ºæ¡†å®šä½ ====================

        function showQRCodePopup(event, planName) {
            const popup = document.getElementById(`qrcode-popup-${planName}`);
            if (!popup) return;

            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();

            // è®¡ç®—ä½ç½®ï¼šæ˜¾ç¤ºåœ¨å³ä¾§
            const left = rect.right + 10;
            const top = rect.top;

            // è®¾ç½®ä½ç½®å¹¶æ˜¾ç¤º
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.style.display = 'block';
        }

        function hideQRCodePopup() {
            const popups = document.querySelectorAll('.qrcode-popup');
            popups.forEach(popup => {
                popup.style.display = 'none';
            });
        }

        // ==================== è‡ªå®šä¹‰å¯¹è¯æ¡†åŠŸèƒ½ ====================

        // è‡ªå®šä¹‰æç¤ºæ¡†
        function showAlert(message, title = 'æç¤º') {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('customAlertModal').classList.add('active');
        }

        function closeCustomAlert() {
            document.getElementById('customAlertModal').classList.remove('active');
        }

        // è‡ªå®šä¹‰ç¡®è®¤æ¡†
        let confirmCallback = null;

        function showConfirm(message, callback, title = 'ç¡®è®¤') {
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('customConfirmModal').classList.add('active');
        }

        function confirmCustomConfirm() {
            document.getElementById('customConfirmModal').classList.remove('active');
            if (confirmCallback) {
                confirmCallback(true);
                confirmCallback = null;
            }
        }

        function cancelCustomConfirm() {
            document.getElementById('customConfirmModal').classList.remove('active');
            if (confirmCallback) {
                confirmCallback(false);
                confirmCallback = null;
            }
        }

        // ==================== å›¾ç‰‡æµè§ˆå™¨åŠŸèƒ½ ====================

        // æ‰“å¼€å›¾ç‰‡æµè§ˆå™¨
        function openImageViewer(images, index, annotations = [], imageRotations = [], recordId = '', planName = '') {
            currentImages = images;
            currentImageIndex = index;
            currentAnnotations = annotations;
            currentImageRotations = imageRotations;
            currentRecordId = recordId;
            currentPlanName = planName || (currentPlan ? currentPlan.plan_name : '');
            pendingRotation = 0;  // é‡ç½®å¾…æäº¤çš„æ—‹è½¬è§’åº¦

            // éšè—ç¡®å®šæŒ‰é’®
            const confirmBtn = document.querySelector('.image-viewer-confirm-btn');
            if (confirmBtn) confirmBtn.style.display = 'none';

            updateImageViewer();
            document.getElementById('imageViewerModal').classList.add('active');
        }

        // å…³é—­å›¾ç‰‡æµè§ˆå™¨
        function closeImageViewer() {
            document.getElementById('imageViewerModal').classList.remove('active');
            currentImages = [];
            currentImageIndex = 0;
            currentAnnotations = [];
            currentImageRotations = [];
            pendingRotation = 0;  // é‡ç½®å¾…æäº¤çš„æ—‹è½¬è§’åº¦
        }

        // ä¸Šä¸€å¼ å›¾ç‰‡
        function prevImage() {
            if (currentImageIndex > 0) {
                pendingRotation = 0;  // åˆ‡æ¢å›¾ç‰‡æ—¶é‡ç½®æ—‹è½¬
                const confirmBtn = document.querySelector('.image-viewer-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'none';

                currentImageIndex--;
                updateImageViewer();
            }
        }

        // ä¸‹ä¸€å¼ å›¾ç‰‡
        function nextImage() {
            if (currentImageIndex < currentImages.length - 1) {
                pendingRotation = 0;  // åˆ‡æ¢å›¾ç‰‡æ—¶é‡ç½®æ—‹è½¬
                const confirmBtn = document.querySelector('.image-viewer-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'none';

                currentImageIndex++;
                updateImageViewer();
            }
        }

        // æ›´æ–°å›¾ç‰‡æµè§ˆå™¨æ˜¾ç¤º
        function updateImageViewer() {
            const img = document.getElementById('imageViewerImg');
            const canvas = document.getElementById('imageViewerCanvas');
            const counter = document.getElementById('imageViewerCounter');
            const prevBtn = document.querySelector('.image-viewer-prev');
            const nextBtn = document.querySelector('.image-viewer-next');
            const wrapper = document.getElementById('imageViewerWrapper');

            // æ›´æ–°å›¾ç‰‡ï¼ˆæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼‰
            const timestamp = Date.now();
            img.src = currentImages[currentImageIndex] + '?t=' + timestamp;

            // åº”ç”¨å¾…æäº¤çš„æ—‹è½¬è§’åº¦
            if (pendingRotation > 0) {
                wrapper.style.transform = `rotate(${pendingRotation}deg)`;
            } else {
                wrapper.style.transform = '';
            }

            // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåç»˜åˆ¶æ ‡æ³¨
            img.onload = function() {
                // è®¾ç½® Canvas å°ºå¯¸ä¸å›¾ç‰‡ä¸€è‡´
                canvas.width = img.width;
                canvas.height = img.height;

                // ç»˜åˆ¶æ ‡æ³¨
                drawAnnotations(canvas, img);
            };

            // æ›´æ–°è®¡æ•°å™¨
            counter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === currentImages.length - 1;
        }

        // æ—‹è½¬å½“å‰å›¾ç‰‡ï¼ˆä»…é¢„è§ˆï¼‰
        function rotateCurrentImage() {
            // ç´¯åŠ æ—‹è½¬è§’åº¦
            pendingRotation = (pendingRotation + 90) % 360;

            // åº”ç”¨CSSæ—‹è½¬é¢„è§ˆ
            const wrapper = document.getElementById('imageViewerWrapper');
            if (pendingRotation > 0) {
                wrapper.style.transform = `rotate(${pendingRotation}deg)`;
            } else {
                wrapper.style.transform = '';
            }

            // æ˜¾ç¤ºç¡®å®šæŒ‰é’®
            const confirmBtn = document.querySelector('.image-viewer-confirm-btn');
            if (pendingRotation > 0) {
                confirmBtn.style.display = 'block';
            } else {
                confirmBtn.style.display = 'none';
            }

            console.log('é¢„è§ˆæ—‹è½¬:', pendingRotation, 'åº¦');
        }

        // ç¡®å®šæ—‹è½¬å¹¶æäº¤
        async function confirmRotation() {
            if (!currentRecordId || !currentPlanName || pendingRotation === 0) {
                return;
            }

            try {
                console.log('æäº¤æ—‹è½¬:', { currentPlanName, currentRecordId, currentImageIndex, rotation: pendingRotation });

                // è°ƒç”¨åç«¯ API ç‰©ç†æ—‹è½¬æ–‡ä»¶
                const response = await fetch(`${API_BASE}/plans/${encodeURIComponent(currentPlanName)}/rotate_image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        record_id: currentRecordId,
                        image_index: currentImageIndex,
                        rotation: pendingRotation
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('åç«¯æ—‹è½¬æˆåŠŸ:', result);

                    // åˆ·æ–°æ•´ä¸ªé¡µé¢ä»¥è·å–æœ€æ–°ç»“æœ
                    location.reload();
                } else {
                    const errorText = await response.text();
                    console.error('åç«¯æ—‹è½¬å¤±è´¥:', response.status, errorText);
                    showAlert('æ—‹è½¬å¤±è´¥: ' + errorText, 'é”™è¯¯');
                }

            } catch (error) {
                console.error('æ—‹è½¬å›¾ç‰‡å¤±è´¥:', error);
                showAlert('æ—‹è½¬å¤±è´¥: ' + error.message, 'é”™è¯¯');
            }
        }

        // ç»˜åˆ¶æ ‡æ³¨åˆ° Canvas
        function drawAnnotations(canvas, img) {
            if (!currentAnnotations || currentAnnotations.length === 0) {
                return;
            }

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // è·å–å›¾ç‰‡çš„å®é™…æ˜¾ç¤ºå°ºå¯¸å’ŒåŸå§‹å°ºå¯¸
            const displayWidth = img.width;
            const displayHeight = img.height;
            const naturalWidth = img.naturalWidth;
            const naturalHeight = img.naturalHeight;

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const scaleX = displayWidth / naturalWidth;
            const scaleY = displayHeight / naturalHeight;

            // åªç»˜åˆ¶å±äºå½“å‰å›¾ç‰‡çš„æ ‡æ³¨
            const currentImageAnnotations = currentAnnotations.filter(annotation => {
                // å¦‚æœæ ‡æ³¨æ²¡æœ‰ image_index å­—æ®µï¼Œé»˜è®¤ä¸ºç¬¬0å¼ å›¾ç‰‡
                const imageIndex = annotation.image_index !== undefined ? annotation.image_index : 0;
                return imageIndex === currentImageIndex;
            });

            // éå†å½“å‰å›¾ç‰‡çš„æ ‡æ³¨
            currentImageAnnotations.forEach(annotation => {
                const bbox = annotation.bbox;
                if (!bbox) return;

                // å°†åŸå§‹åæ ‡è½¬æ¢ä¸ºæ˜¾ç¤ºåæ ‡
                const x = bbox.x * scaleX;
                const y = bbox.y * scaleY;
                const width = bbox.width * scaleX;
                const height = bbox.height * scaleY;

                // æ ¹æ®çŠ¶æ€é€‰æ‹©é¢œè‰²
                let color, bgColor, icon;
                if (annotation.status === 'correct') {
                    color = '#28a745';
                    bgColor = 'rgba(40, 167, 69, 0.1)';
                    icon = 'âœ“';
                } else if (annotation.status === 'partial') {
                    color = '#ff9800';
                    bgColor = 'rgba(255, 152, 0, 0.1)';
                    icon = 'â–³';
                } else {
                    color = '#dc3545';
                    bgColor = 'rgba(220, 53, 69, 0.1)';
                    icon = 'âœ—';
                }

                // ç»˜åˆ¶åŠé€æ˜èƒŒæ™¯
                ctx.fillStyle = bgColor;
                ctx.fillRect(x, y, width, height);

                // ç»˜åˆ¶çŸ©å½¢æ¡†
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);

                // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
                const labelText = `${icon} é¢˜${annotation.question_number} ${annotation.score}`;
                ctx.font = 'bold 16px Arial';
                const textMetrics = ctx.measureText(labelText);
                const labelWidth = textMetrics.width + 16;
                const labelHeight = 28;

                ctx.fillStyle = color;
                ctx.fillRect(x, y - labelHeight, labelWidth, labelHeight);

                // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.textBaseline = 'middle';
                ctx.fillText(labelText, x + 8, y - labelHeight / 2);
            });
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyPress(e) {
            const modal = document.getElementById('imageViewerModal');
            if (!modal.classList.contains('active')) return;

            switch(e.key) {
                case 'ArrowLeft':
                    prevImage();
                    break;
                case 'ArrowRight':
                    nextImage();
                    break;
                case 'Escape':
                    closeImageViewer();
                    break;
            }
        }
    </script>
</body>
</html>
